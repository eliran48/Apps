<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח הכנסות חזוי</title>
    <!-- טעינת Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- טעינת Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            setDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- קבועים גלובליים ---
        let db, auth, userId, appId;
        let allPayments = [];
        let allCustomers = [];
        let currentMonthOffset = 0; // 0 = חודש נוכחי, 1 = חודש הבא, -1 = חודש קודם

        const monthNames = ["ינואר", "פברואר", "מרץ", "אפריל", "מאי", "יוני", "יולי", "אוגוסט", "ספטמבר", "אוקטובר", "נובמבר", "דצמבר"];
        
        // --- איתחול Firebase ---
        async function initFirebase() {
            try {
                // קבלת הגדרות וטוקן מהסביבה
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // --- שינוי ---
                // הגדרת תצורה קבועה עבור GitHub Pages (בתור גיבוי)
                // אלו הפרטים שאתה סיפקת
                const githubFallbackConfig = {
                    apiKey: "AIzaSyDFYvzKavhrf4bnoFI0GckLk-dO40_ftJ4",
                    authDomain: "eliran-apps.firebaseapp.com",
                    projectId: "eliran-apps",
                    storageBucket: "eliran-apps.firebasestorage.app",
                    messagingSenderId: "383762752947",
                    appId: "1:383762752947:web:7b83b2dcc31f2a5cf557c6",
                    measurementId: "G-1DNCHTV0W3"
                };

                // בדיקה אם הקוד רץ בסביבה שלנו או בחוץ
                // אם __firebase_config לא קיים, השתמש בגיבוי
                const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(githubFallbackConfig);
                const firebaseConfig = JSON.parse(configString);
                // --- סוף שינוי ---
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // איתחול אפליקציה ושרותים
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // התחברות
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("משתמש מחובר:", userId);
                        // טעינת נתונים ראשונית לאחר התחברות
                        setupSnapshots(); // --- This will now only attach listeners
                        
                        // --- שינוי ---
                        // נסתיר את הספינר ונציג את האפליקציה מיד
                        // הנתונים יטענו ברקע
                        document.getElementById('loading-spinner').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        
                        showDashboardView(); // הצג דאשבורד לאחר אימות
                        // --- סוף שינוי ---
                    } else {
                        // אם אין משתמש, נסה להתחבר
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("שגיאת התחברות:", authError);
                            document.getElementById('loading-spinner').classList.add('hidden');
                            document.getElementById('app-container').innerHTML = '<p class="text-red-500 text-center">שגיאת התחברות. לא ניתן לטעון את האפליקציה.</p>';
                        }
                    }
                });

            } catch (e) {
                console.error("שגיאה באתחול Firebase:", e);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('app-container').innerHTML = '<p class="text-red-500 text-center">שגיאה קריטית באתחול האפליקציה.</p>';
            }
        }

        // --- הגדרת מאזיני Firestore ---
        function setupSnapshots() {
            if (!userId || !appId) return;

            const customersPath = `artifacts/${appId}/users/${userId}/customers`;
            const paymentsPath = `artifacts/${appId}/users/${userId}/payments`;

            // מאזין ללקוחות
            const qCustomers = query(collection(db, customersPath));
            onSnapshot(qCustomers, (snapshot) => {
                allCustomers = [];
                snapshot.forEach(doc => {
                    allCustomers.push({ id: doc.id, ...doc.data() });
                });
                console.log("לקוחות נטענו:", allCustomers.length);
                populateCustomerDatalist();
                // אם אנחנו בתצוגת הטופס, רענן את הרשימה
                if (document.getElementById('payment-form-view').style.display !== 'none') {
                    populateCustomerDatalist();
                }
            }, (error) => console.error("שגיאה בטעינת לקוחות:", error));

            // מאזין לתשלומים
            const qPayments = query(collection(db, paymentsPath));
            onSnapshot(qPayments, (snapshot) => {
                allPayments = [];
                snapshot.forEach(doc => {
                    allPayments.push({ id: doc.id, ...doc.data() });
                });
                console.log("תשלומים נטענו:", allPayments.length);
                // רענון התצוגה הנוכחית
                if (document.getElementById('dashboard-view').style.display !== 'none') {
                    renderDashboard();
                } else if (document.getElementById('collection-view').style.display !== 'none') {
                    renderCollectionView();
                }
                // --- שינוי ---
                // הסרנו את הסתרת הספינר מכאן
                // document.getElementById('loading-spinner').classList.add('hidden');
                // document.getElementById('app-container').classList.remove('hidden');
                // --- סוף שינוי ---
            }, (error) => console.error("שגיאה בטעינת תשלומים:", error));
        }

        // --- לוגיקת תצוגות ---
        function showView(viewId) {
            const views = ['dashboard-view', 'payment-form-view', 'collection-view', 'reports-view']; // הוספתי תצוגת דוחות
            views.forEach(id => {
                document.getElementById(id).style.display = (id === viewId) ? 'block' : 'none';
            });
            window.scrollTo(0, 0); // גלול לראש הדף
        }

        function showDashboardView() {
            currentMonthOffset = 0; // איתחול לחודש נוכחי
            renderDashboard();
            showView('dashboard-view');
        }

        // --- הוספתי את הפונקציה החסרה ---
        function renderDashboard() {
            // 1. חישוב סך הגבייה
            const collectionPayments = allPayments.filter(p => p.status === 'collection');
            const collectionTotal = collectionPayments.reduce((sum, p) => sum + p.amount, 0);
            
            // 2. עדכון התגית
            const collectionBadge = document.getElementById('collection-total-badge');
            if (collectionTotal > 0) {
                collectionBadge.innerText = `₪${collectionTotal.toLocaleString()}`;
                collectionBadge.classList.remove('hidden');
            } else {
                collectionBadge.classList.add('hidden');
            }

            // 3. רינדור כרטיסיות חודשים
            const monthsContainer = document.getElementById('months-carousel');
            monthsContainer.innerHTML = ''; // נקה תצוגה קודמת
            const today = new Date();
            
            // 4. לולאה
            for (let i = -1; i <= 1; i++) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() + currentMonthOffset + i, 1);
                const monthIndex = monthDate.getMonth();
                const year = monthDate.getFullYear();
                
                // 5. יצירה והוספה
                const monthCard = createMonthCard(monthIndex, year);
                monthsContainer.appendChild(monthCard);
                
                // 6. הדגשה
                if (i === 0) {
                    monthCard.classList.add('border-4', 'border-blue-500', 'scale-105');
                    monthCard.classList.remove('border-gray-200');
                }
            }
        }
        // --- סוף הפונקציה החסרה ---

        function showPaymentFormView(paymentToEdit = null) {
            const form = document.getElementById('payment-form');
            form.reset();
            document.getElementById('form-title').innerText = "קליטת תשלום חדש";
            form.dataset.editId = "";

            if (paymentToEdit) {
                document.getElementById('form-title').innerText = "הסדרת תשלום לגבייה";
                form.dataset.editId = paymentToEdit.id;
                document.getElementById('customer-name-input').value = paymentToEdit.customerName;
                document.getElementById('customer-name-input').disabled = true;
                document.getElementById('payment-amount').value = paymentToEdit.amount;
                document.getElementById('payment-amount').disabled = true;
                // אל תמלא את סוג התשלום, המשתמש צריך לבחור את התנאי *החדש*
            } else {
                document.getElementById('customer-name-input').disabled = false;
                document.getElementById('payment-amount').disabled = false;
            }

            populateCustomerDatalist();
            showView('payment-form-view');
        }

        function showCollectionView() {
            renderCollectionView();
            showView('collection-view');
        }

        // --- פונקציות חדשות לדוחות ---
        function showReportsView() {
            renderReports(); // קריאה לפונקציית רינדור הדוחות
            showView('reports-view');
        }

        function renderReports() {
            renderReportByCustomer();
            renderReportByMonth();
            renderReportByYear();
        }

        // פונקציית עזר לקבלת תשלומים רלוונטיים לדוחות
        function getValidPayments() {
            // ניקח רק תשלומים שיש להם תאריך צפוי והם לא בגבייה
            return allPayments.filter(p => p.status !== 'collection' && p.expectedDate);
        }

        function renderReportByCustomer() {
            const validPayments = getValidPayments();
            const customerTotals = {};

            validPayments.forEach(p => {
                if (!customerTotals[p.customerName]) {
                    customerTotals[p.customerName] = 0;
                }
                customerTotals[p.customerName] += p.amount;
            });

            // מיון לפי סכום, מהגבוה לנמוך
            const sortedCustomers = Object.entries(customerTotals)
                .sort(([, a], [, b]) => b - a);

            const listEl = document.getElementById('report-by-customer-list');
            listEl.innerHTML = '';
            if (sortedCustomers.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500">אין נתונים להצגה</li>';
                return;
            }

            sortedCustomers.forEach(([name, total]) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between p-2 border-b last:border-b-0';
                li.innerHTML = `<span>${name}</span><span class="font-semibold">₪${total.toLocaleString()}</span>`;
                listEl.appendChild(li);
            });
        }

        function renderReportByMonth() {
            const validPayments = getValidPayments();
            const monthTotals = {};

            validPayments.forEach(p => {
                const d = new Date(p.expectedDate);
                const key = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`; // "2025-10"
                if (!monthTotals[key]) {
                    monthTotals[key] = 0;
                }
                monthTotals[key] += p.amount;
            });

            // מיון לפי מפתח (החודש), מהחדש לישן
            const sortedMonths = Object.keys(monthTotals).sort().reverse();

            const listEl = document.getElementById('report-by-month-list');
            listEl.innerHTML = '';
            if (sortedMonths.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500">אין נתונים להצגה</li>';
                return;
            }

            sortedMonths.forEach(key => {
                const [year, month] = key.split('-');
                const monthName = monthNames[parseInt(month, 10) - 1];
                const total = monthTotals[key];
                
                const li = document.createElement('li');
                li.className = 'flex justify-between p-2 border-b last:border-b-0';
                li.innerHTML = `<span>${monthName} ${year}</span><span class="font-semibold">₪${total.toLocaleString()}</span>`;
                listEl.appendChild(li);
            });
        }

        function renderReportByYear() {
            const validPayments = getValidPayments();
            const yearTotals = {};

            validPayments.forEach(p => {
                const year = new Date(p.expectedDate).getFullYear().toString();
                if (!yearTotals[year]) {
                    yearTotals[year] = 0;
                }
                yearTotals[year] += p.amount;
            });

            // מיון לפי שנה, מהחדשה לישנה
            const sortedYears = Object.keys(yearTotals).sort().reverse();

            const listEl = document.getElementById('report-by-year-list');
            listEl.innerHTML = '';
            if (sortedYears.length === 0) {
                listEl.innerHTML = '<li class="text-gray-500">אין נתונים להצגה</li>';
                return;
            }

            sortedYears.forEach(year => {
                const total = yearTotals[year];
                const li = document.createElement('li');
                li.className = 'flex justify-between p-2 border-b last:border-b-0';
                li.innerHTML = `<span>${year}</span><span class="font-semibold">₪${total.toLocaleString()}</span>`;
                listEl.appendChild(li);
            });
        }
        // --- סוף פונקציות דוחות ---


        function createMonthCard(monthIndex, year) {
            const card = document.createElement('div');
            card.className = "month-card min-w-[280px] w-full max-w-sm bg-white p-6 rounded-lg shadow-lg border border-gray-200 transition-all duration-300 transform";
            
            const monthName = monthNames[monthIndex];
            const title = document.createElement('h3');
            title.className = "text-xl font-bold text-center mb-4";
            title.innerText = `${monthName} ${year}`;
            
            // חישוב סכומים
            const { expectedTotal, receivedTotal } = getMonthTotals(monthIndex, year);
            
            const totalEl = document.createElement('div');
            totalEl.className = "text-3xl font-bold text-center text-blue-600 mb-2";
            totalEl.innerText = `₪${expectedTotal.toLocaleString()}`;
            
            const subtitleEl = document.createElement('div');
            subtitleEl.className = "text-sm text-center text-gray-500 mb-4";
            subtitleEl.innerText = "סך הכל צפוי";
            
            const receivedEl = document.createElement('div');
            receivedEl.className = "text-lg font-semibold text-center text-green-600";
            receivedEl.innerText = `₪${receivedTotal.toLocaleString()}`;
            
            const receivedSubtitleEl = document.createElement('div');
            receivedSubtitleEl.className = "text-sm text-center text-gray-500";
            receivedSubtitleEl.innerText = "מתוכם התקבלו";
            
            card.append(title, totalEl, subtitleEl, receivedEl, receivedSubtitleEl);
            return card;
        }

        function getMonthTotals(monthIndex, year) {
            let expectedTotal = 0;
            let receivedTotal = 0;
            
            const startOfMonth = new Date(year, monthIndex, 1).getTime();
            const endOfMonth = new Date(year, monthIndex + 1, 0).getTime();

            allPayments.forEach(p => {
                if (p.status === 'collection' || !p.expectedDate) return;
                
                const expectedTime = new Date(p.expectedDate).getTime();
                
                if (expectedTime >= startOfMonth && expectedTime <= endOfMonth) {
                    expectedTotal += p.amount;
                    if (p.status === 'received') {
                        receivedTotal += p.amount;
                    }
                }
            });
            
            return { expectedTotal, receivedTotal };
        }
        
        function renderCollectionView() {
            const collectionList = document.getElementById('collection-list');
            collectionList.innerHTML = ''; // נקה רשימה
            
            const collectionPayments = allPayments.filter(p => p.status === 'collection');
            
            if (collectionPayments.length === 0) {
                collectionList.innerHTML = '<p class="text-gray-500 text-center">אין תשלומים בחלון הגבייה.</p>';
                document.getElementById('collection-total').innerText = '₪0';
                return;
            }
            
            let total = 0;
            collectionPayments.forEach(p => {
                total += p.amount;
                const item = document.createElement('li');
                item.className = "flex justify-between items-center bg-white p-4 rounded-lg shadow mb-2";
                
                const info = document.createElement('div');
                info.innerHTML = `
                    <span class="font-bold">${p.customerName}</span>
                    <span class="text-gray-600"> - ₪${p.amount.toLocaleString()}</span>
                `;
                
                const settleBtn = document.createElement('button');
                settleBtn.innerText = "הסדר תשלום";
                settleBtn.className = "bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600";
                settleBtn.onclick = () => showPaymentFormView(p);
                
                item.append(info, settleBtn);
                collectionList.appendChild(item);
            });
            
            document.getElementById('collection-total').innerText = `₪${total.toLocaleString()}`;
        }
        
        function populateCustomerDatalist() {
            const datalist = document.getElementById('customers-list');
            datalist.innerHTML = '';
            allCustomers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                datalist.appendChild(option);
            });
        }

        // --- לוגיקת טופס ---
        async function handlePaymentFormSubmit(e) {
            e.preventDefault();
            if (!userId) {
                // במקום alert, נשתמש בהודעה פנימית אם אפשר, אבל alert פשוט יותר כרגע
                console.error("שגיאה: המשתמש אינו מחובר.");
                return;
            }

            const form = e.target;
            const customerName = document.getElementById('customer-name-input').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const paymentType = document.getElementById('payment-type').value;
            const editId = form.dataset.editId;

            if (!customerName || !amount || !paymentType) {
                console.error("אנא מלא את כל השדות."); // עדיף להציג הודעה למשתמש
                return;
            }

            // 1. טיפול בלקוח
            let customerId;
            let customer = allCustomers.find(c => c.name === customerName);
            if (!customer) {
                // לקוח חדש
                try {
                    const customersPath = `artifacts/${appId}/users/${userId}/customers`;
                    const docRef = await addDoc(collection(db, customersPath), { name: customerName });
                    customerId = docRef.id;
                    console.log("לקוח חדש נוצר:", customerId);
                } catch (error) {
                    console.error("שגיאה ביצירת לקוח חדש:", error);
                    return;
                }
            } else {
                customerId = customer.id;
            }

            // 2. חישוב תאריך וסטטוס
            const logDate = new Date();
            const { expectedDate, status } = calculatePaymentDetails(paymentType, logDate);

            // 3. יצירת אובייקט תשלום
            const paymentData = {
                customerId,
                customerName,
                amount,
                paymentType,
                logDate: logDate.toISOString(),
                expectedDate: expectedDate ? expectedDate.toISOString() : null,
                status
            };

            // 4. שמירה ב-Firestore
            try {
                const paymentsPath = `artifacts/${appId}/users/${userId}/payments`;
                if (editId) {
                    // זה היה תשלום עתידי שעכשיו מוסדר
                    // אנחנו מעדכנים את הרשומה הקיימת
                    const paymentRef = doc(db, paymentsPath, editId);
                    await setDoc(paymentRef, paymentData);
                    console.log("תשלום עתידי הוסדר:", editId);
                } else {
                    // תשלום חדש
                    await addDoc(collection(db, paymentsPath), paymentData);
                    console.log("תשלום חדש נשמר");
                }
                
                // איפוס הטופס וחזרה לדאשבורד
                form.reset();
                form.dataset.editId = "";
                showDashboardView();
                
            } catch (error) {
                console.error("שגיאה בשמירת התשלום:", error);
            }
        }
        
        function calculatePaymentDetails(paymentType, logDate) {
            let expectedDate = new Date(logDate.getTime());
            let status = 'expected';

            switch (paymentType) {
                case 'immediate':
                    status = 'received';
                    // expectedDate נשאר היום
                    break;
                case 'current': // שוטף (במהלך חודש הבא)
                    expectedDate = new Date(logDate.getFullYear(), logDate.getMonth() + 2, 0); // סוף חודש הבא
                    break;
                case 'current_30': // שוטף + 30 (סוף חודש הבא)
                    expectedDate = new Date(logDate.getFullYear(), logDate.getMonth() + 2, 0); // סוף חודש הבא
                    break;
                case 'current_45':
                    expectedDate.setDate(logDate.getDate() + 45);
                    break;
                case 'current_60':
                    expectedDate.setDate(logDate.getDate() + 60);
                    break;
                case 'future':
                    expectedDate = null;
                    status = 'collection';
                    break;
            }
            
            return { expectedDate, status };
        }

        // --- ניווט חודשים ---
        function changeMonth(direction) {
            currentMonthOffset += direction;
            renderDashboard();
        }

        // --- איתחול כללי ---
        document.addEventListener('DOMContentLoaded', () => {
            // חיבור Event Listeners
            document.getElementById('add-payment-btn').onclick = () => showPaymentFormView(null);
            document.getElementById('collection-btn').onclick = showCollectionView;
            document.getElementById('reports-btn').onclick = showReportsView; // הוספת ליסנר לכפתור דוחות
            document.getElementById('payment-form').onsubmit = handlePaymentFormSubmit;
            
            document.getElementById('cancel-form-btn').onclick = showDashboardView;
            document.getElementById('back-to-dashboard-btn').onclick = showDashboardView;
            document.getElementById('back-to-dashboard-from-reports-btn').onclick = showDashboardView; // הוספת ליסנר לכפתור חזרה מדוחות
            
            document.getElementById('prev-month-btn').onclick = () => changeMonth(-1);
            document.getElementById('next-month-btn').onclick = () => changeMonth(1);
            
            // הסתר את כל התצוגות והצג טעינה
            showView(null); // מסתיר הכל
            document.getElementById('app-container').classList.add('hidden'); // הסתר את האפליקציה
            document.getElementById('loading-spinner').classList.remove('hidden'); // הצג ספינר
            
            // התחל את תהליך Firebase
            initFirebase();
        });

    </script>
    
    <style>
        /* סגנון עברי וכללי */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f7fafc; /* אפור בהיר */
        }
        /* הסתרת סרגל הגלילה של הקרוסלה */
        #months-carousel::-webkit-scrollbar {
            display: none;
        }
        #months-carousel {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* תיקון קל לכפתור ההסדרה ברשימת הגבייה */
        #collection-list button {
            flex-shrink: 0; /* מונע מהכפתור להתכווץ */
        }
        #collection-list div {
            overflow-wrap: break-word; /* גורם לשמות ארוכים להישבר */
            min-width: 0; /* עוזר לגלישה */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- מסך טעינה התחלתי -->
    <div id="loading-spinner" class="flex justify-center items-center min-h-screen">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <!-- קונטיינר ראשי של האפליקציה (מוסתר בהתחלה) -->
    <div id="app-container" class="max-w-4xl mx-auto p-4 hidden">

        <!-- ===== 1. תצוגת דאשבורד (ראשית) ===== -->
        <div id="dashboard-view" style="display: none;">
            <header class="flex justify-between items-center mb-6 flex-wrap gap-2">
                <h1 class="text-3xl font-bold text-gray-800">לוח הכנסות</h1>
                <div class="space-x-2 space-x-reverse flex items-center flex-wrap gap-2">
                    <!-- שיניתי את הכפתור להכיל תגית -->
                    <button id="collection-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600 transition-all flex items-center space-x-2 space-x-reverse">
                        <span>חלון גבייה</span>
                        <span id="collection-total-badge" class="bg-yellow-700 text-xs font-bold px-2 py-0.5 rounded-full hidden">₪0</span>
                    </button>
                    <!-- כפתור דוחות חדש -->
                    <button id="reports-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition-all">
                        דוחות
                    </button>
                    <button id="add-payment-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">
                        + קליטת תשלום
                    </button>
                </div>
            </header>

            <!-- ניווט חודשים -->
            <div class="flex justify-between items-center mb-4">
                <button id="next-month-btn" class="bg-gray-200 p-3 rounded-full hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
                <h2 class="text-xl font-semibold">תחזית חודשית</h2>
                <button id="prev-month-btn" class="bg-gray-200 p-3 rounded-full hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
            </div>

            <!-- קרוסלת חודשים -->
            <div id="months-carousel" class="flex overflow-x-auto gap-4 p-4 justify-center items-center snap-x snap-mandatory">
                <!-- כרטיסיות החודשים יוכנסו כאן על ידי JS -->
            </div>
            
            <p class="text-center text-gray-500 mt-4 text-sm">מוצגים 3 חודשים בכל פעם. לחצו על החיצים לניווט.</p>
        </div>

        <!-- ===== 2. תצוגת טופס קליטת תשלום ===== -->
        <div id="payment-form-view" style="display: none;">
            <h2 id="form-title" class="text-2xl font-bold mb-6">קליטת תשלום חדש</h2>
            <form id="payment-form" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                
                <div>
                    <label for="customer-name-input" class="block text-sm font-medium text-gray-700">שם לקוח (בחר או הקלד חדש)</label>
                    <input list="customers-list" id="customer-name-input" name="customer-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    <datalist id="customers-list">
                        <!-- אופציות לקוח יוכנסו כאן על ידי JS -->
                    </datalist>
                </div>

                <div>
                    <label for="payment-amount" class="block text-sm font-medium text-gray-700">סכום (בש"ח)</label>
                    <input type="number" id="payment-amount" name="payment-amount" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>

                <div>
                    <label for="payment-type" class="block text-sm font-medium text-gray-700">סוג תשלום</label>
                    <select id="payment-type" name="payment-type" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>בחר סוג תשלום...</option>
                        <option value="immediate">מיידי</option>
                        <option value="current">שוטף (במהלך חודש הבא)</option>
                        <option value="current_30">שוטף + 30 (סוף חודש הבא)</option>
                        <option value="current_45">שוטף + 45</option>
                        <option value="current_60">שוטף + 60</option>
                        <option value="future">תשלום עתידי (לגבייה)</option>
                    </select>
                </div>

                <div class="flex justify-start space-x-4 space-x-reverse pt-4">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-all">שמור תשלום</button>
                    <button type="button" id="cancel-form-btn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 transition-all">ביטול</button>
                </div>
            </form>
        </div>

        <!-- ===== 3. תצוגת חלון גבייה ===== -->
        <div id="collection-view" style="display: none;">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">חלון גבייה</h2>
                <button id="back-to-dashboard-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-all">
                    חזור לדאשבורד
                </button>
            </header>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-4">
                <h3 class="text-lg font-semibold">סך הכל לגבייה</h3>
                <div id="collection-total" class="text-3xl font-bold text-yellow-600">₪0</div>
            </div>

            <ul id="collection-list" class="space-y-3">
                <!-- רשימת התשלומים לגבייה תוכנס כאן על ידי JS -->
            </ul>
        </div>

        <!-- ===== 4. תצוגת דוחות (חדש) ===== -->
        <div id="reports-view" style="display: none;">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">דוחות הכנסה</h2>
                <button id="back-to-dashboard-from-reports-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-all">
                    חזור לדאשבורד
                </button>
            </header>

            <div class="space-y-6">
                <!-- דוח לפי לקוח -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">הכנסות לפי לקוח</h3>
                    <ul id="report-by-customer-list" class="max-h-60 overflow-y-auto">
                        <!-- תוכן יוכנס על ידי JS -->
                    </ul>
                </div>
                
                <!-- דוח לפי חודש -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">הכנסות לפי חודש</h3>
                    <ul id="report-by-month-list" class="max-h-60 overflow-y-auto">
                        <!-- תוכן יוכנס על ידי JS -->
                    </ul>
                </div>
                
                <!-- דוח לפי שנה -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">הכנסות לפי שנה</h3>
                    <ul id="report-by-year-list" class="max-h-60 overflow-y-auto">
                        <!-- תוכן יוכנס על ידי JS -->
                    </ul>
                </div>
            </div>
        </div>

    </div>
</body>
</html>




