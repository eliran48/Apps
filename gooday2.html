<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>יומן הטוב</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/he.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/isSameOrBefore.js"></script> <!-- Added for streak calculation -->
    <style>
        :root {
            --bg-gradient-start: #E6F3FF;
            --bg-gradient-end: #F5F7FA;
            --primary-color: #3182CE;
            --primary-hover-color: #2B6CB0;
            --header-color: #3182CE;
            --text-color: #2D3748;
            --subtle-text-color: #718096;
            --border-color: #BEE3F8;
            --textarea-bg: rgba(255, 255, 255, 0.7);
        }

        body {
            font-family: 'Assistant', sans-serif;
            background-color: #F0F4F8;
            color: var(--text-color);
        }
        
        .theme-ocean {
            --bg-gradient-start: #E0F2F1;
            --bg-gradient-end: #F1F8E9;
            --primary-color: #00796B;
            --primary-hover-color: #004D40;
            --header-color: #00796B;
        }

        .theme-sunset {
            --bg-gradient-start: #FFF3E0;
            --bg-gradient-end: #FFECB3;
            --primary-color: #F57C00;
            --primary-hover-color: #E65100;
            --header-color: #F57C00;
        }
        
        .theme-forest {
            --bg-gradient-start: #F0FFF4;
            --bg-gradient-end: #E6FFFA;
            --primary-color: #38A169;
            --primary-hover-color: #2F855A;
            --header-color: #276749;
        }

        .theme-galaxy {
            --bg-gradient-start: #1A202C;
            --bg-gradient-end: #0D1117;
            --primary-color: #9F7AEA;
            --primary-hover-color: #805AD5;
            --header-color: #C4B5FD;
            --text-color: #E2E8F0;
            --subtle-text-color: #A0AEC0;
            --border-color: #4A5568;
            --textarea-bg: rgba(45, 55, 72, 0.7);
        }

        body.theme-galaxy {
          background-color: #0D1117;
          background-image:
            radial-gradient(1px 1px at 20px 30px, #eee, transparent),
            radial-gradient(1px 1px at 40px 70px, #fff, transparent),
            radial-gradient(1px 1px at 50px 160px, #ddd, transparent),
            radial-gradient(1px 1px at 90px 40px, #fff, transparent),
            radial-gradient(2px 2px at 130px 80px, #fff, transparent),
            radial-gradient(2px 2px at 160px 120px, #ddd, transparent);
          background-repeat: repeat;
          background-size: 200px 200px;
        }

        .main-container {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        }
        .journal-textarea {
            background-color: var(--textarea-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .journal-textarea::placeholder {
            color: var(--subtle-text-color);
            opacity: 0.8;
        }
        .journal-textarea:focus {
            background-color: color-mix(in srgb, var(--textarea-bg) 50%, white);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 50%, transparent);
        }
        .header-text {
             color: var(--header-color);
        }
        .subtle-text {
            color: var(--subtle-text-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s ease;
        }
        .theme-galaxy .btn-primary {
             color: #1A202C;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover-color);
        }
        .btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
            transition: background-color 0.3s ease;
        }
        .theme-galaxy .btn-secondary {
             background-color: #2D3748;
             color: #E2E8F0;
        }
        .btn-secondary:hover {
            background-color: #CBD5E0;
        }
        .theme-galaxy .btn-secondary:hover {
            background-color: #4A5568;
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            background-color: var(--border-color);
        }
        .has-entry {
            background-color: #68D391;
            color: white;
            border-radius: 50%;
            font-weight: bold;
        }
        .theme-galaxy .has-entry {
            color: #1A202C;
        }
        .selected-day {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
        }
        .theme-galaxy .selected-day {
             color: #1A202C;
        }
        .toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .settings-panel {
            transition: opacity 0.3s, transform 0.3s;
        }

        /* Galaxy Theme Overrides */
        body.theme-galaxy #journal-view label.font-semibold,
        body.theme-galaxy #journal-date-display,
        body.theme-galaxy #calendar-month-year,
        body.theme-galaxy #entry-date,
        body.theme-galaxy #inspiration-title {
            color: #FFFFFF;
        }
        body.theme-galaxy nav { background-color: rgba(26, 32, 44, 0.7); backdrop-filter: blur(5px); border: 1px solid #4A5568; }
        body.theme-galaxy #streak-display { background-color: rgba(26, 32, 44, 0.7); color: var(--subtle-text-color); border: 1px solid #4A5568; } /* Added galaxy style for streak */
        body.theme-galaxy #history-entry-display,
        body.theme-galaxy #modal-content { background-color: #1A202C; }
        body.theme-galaxy #settings-panel { background-color: #2D3748; }
        body.theme-galaxy .theme-btn { color: var(--text-color); }
        body.theme-galaxy .theme-btn:hover { background-color: #4A5568; }
        body.theme-galaxy .bg-yellow-100 { background-color: rgba(74, 85, 104, 0.5); border-color: var(--primary-color); color: var(--text-color); }
        body.theme-galaxy label[for="image-upload"] { background-color: #2D3748; border-color: #4A5568; color: var(--text-color); }
        body.theme-galaxy #entry-content .text-green-600 { color: #68D391; }
        body.theme-galaxy #entry-content .text-blue-600 { color: #63B3ED; }
        body.theme-galaxy #entry-content .text-pink-500 { color: #ED64A6; }
        body.theme-galaxy .inspiration-card {
            background-color: rgba(45, 55, 72, 0.7);
            border-color: #4A5568;
        }
        body.theme-galaxy .inspiration-card-date {
            color: var(--subtle-text-color);
        }
        
        .inspiration-card {
            background-color: rgba(255, 255, 255, 0.7);
            border-right-width: 4px;
            transition: all 0.3s ease;
        }
        .inspiration-card:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .inspiration-card-good { border-color: #68D391; }
        .inspiration-card-success { border-color: #63B3ED; }
        .inspiration-card-gratitude { border-color: #ED64A6; }

        .streak-counter {
            color: var(--subtle-text-color);
            white-space: nowrap; /* Prevent text wrapping */
        }
        /* Removed .active style as it's less relevant now */
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-xl mx-auto p-4 sm:p-6 min-h-screen">
        <!-- Header -->
        <header class="text-center mb-6 relative">
            <h1 class="text-4xl sm:text-5xl font-bold header-text">יומן הטוב שלי</h1>
            <p class="text-lg subtle-text">המקום לטפח חשיבה חיובית, ערך עצמי והודיה</p>
             <!-- Settings Button and Panel -->
            <div class="absolute top-0 left-0">
                <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 transition">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <div id="settings-panel" class="settings-panel hidden absolute left-0 mt-2 w-40 bg-white rounded-lg shadow-xl p-2 z-10 opacity-0 transform -translate-y-2">
                    <h4 class="text-sm font-bold text-gray-600 px-2 pb-1 text-right">ערכת צבעים</h4>
                    <button class="theme-btn w-full text-right p-2 hover:bg-gray-100 rounded" data-theme="default">🔵 ברירת מחדל</button>
                    <button class="theme-btn w-full text-right p-2 hover:bg-gray-100 rounded" data-theme="ocean">🌊 אוקיינוס</button>
                    <button class="theme-btn w-full text-right p-2 hover:bg-gray-100 rounded" data-theme="sunset">🌅 שקיעה</button>
                    <button class="theme-btn w-full text-right p-2 hover:bg-gray-100 rounded" data-theme="forest">🌲 יער</button>
                    <button class="theme-btn w-full text-right p-2 hover:bg-gray-100 rounded" data-theme="galaxy">🌌 גלקסיה</button>
                </div>
            </div>
        </header>

        <!-- Navigation & Streak Container -->
        <div class="flex flex-col items-center mb-6 gap-2">
            <nav class="flex justify-center bg-white rounded-full shadow-md p-1 w-full max-w-sm">
                <button id="journal-view-btn" class="px-6 py-2 rounded-full text-lg font-semibold flex-1 text-center btn-primary">יומן יומי</button>
                <button id="history-view-btn" class="px-6 py-2 rounded-full text-lg font-semibold flex-1 text-center btn-secondary">היסטוריה</button>
            </nav>
            <!-- Streak Display Below Navigation -->
            <div id="streak-display" class="streak-counter p-1 px-3 bg-white rounded-full shadow-md text-sm">
                 ימי כתיבה ברצף: <span id="streak-count" class="font-bold">0</span>
            </div>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="main-container rounded-2xl shadow-lg p-6 sm:p-8">
            <!-- Journal View -->
            <div id="journal-view">
                <div class="text-center mb-6">
                    <p class="text-xl font-semibold" id="journal-date-display"></p>
                </div>

                <!-- Inspiration Corner -->
                <div class="bg-yellow-100 border-r-4 border-yellow-400 text-yellow-800 p-4 rounded-lg mb-6 text-center italic">
                    <p id="quote-text">טעינת ציטוט...</p>
                    <p id="quote-author" class="text-sm mt-1 not-italic font-semibold"></p>
                </div>

                <!-- Daily Photo Section -->
                <div class="mb-6">
                     <label class="block text-xl font-semibold mb-2">📸 תמונת היום</label>
                     <div class="mt-2 flex flex-col items-center">
                        <img id="image-preview" src="" class="hidden max-h-60 rounded-lg shadow mb-2"/>
                        <div id="image-controls" class="flex items-center gap-2">
                           <label for="image-upload" class="cursor-pointer bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50">בחר/י תמונה</label>
                           <input id="image-upload" type="file" class="hidden" accept="image/*">
                           <button id="remove-image-btn" class="hidden p-2 text-red-500 hover:bg-red-100 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                           </button>
                        </div>
                     </div>
                </div>

                <!-- Journal Sections -->
                <div class="space-y-6">
                    <div>
                        <label for="good-things" class="block text-xl font-semibold mb-2">🌱 הדברים הטובים שקרו לי היום</label>
                        <textarea id="good-things" rows="5" class="journal-textarea w-full p-3 rounded-lg text-lg" placeholder="לדוגמה: שיחה טובה עם חבר, ארוחה טעימה, שיר יפה ששמעתי..."></textarea>
                    </div>
                    <div>
                        <label for="successes" class="block text-xl font-semibold mb-2">🏆 ההצלחות שלי להיום</label>
                        <textarea id="successes" rows="3" class="journal-textarea w-full p-3 rounded-lg text-lg" placeholder="לדוגמה: סיימתי משימה חשובה בעבודה, עמדתי ביעד באימון..."></textarea>
                    </div>
                    <div>
                        <label for="gratitude" class="block text-xl font-semibold mb-2">💖 תודה על...</label>
                        <textarea id="gratitude" rows="3" class="journal-textarea w-full p-3 rounded-lg text-lg" placeholder="לדוגמה: המשפחה שלי, הבריאות, קורת הגג שמעל ראשי..."></textarea>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="save-button" class="btn-primary font-bold py-3 px-8 rounded-full text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 w-full sm:w-auto">
                        שמור את היום הטוב שלי
                    </button>
                     <button id="back-to-today-btn" class="hidden btn-secondary font-bold py-3 px-6 rounded-full text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 w-full sm:w-auto">
                        חזרה ליומן של היום
                    </button>
                    <button id="tomorrow-message-btn" class="btn-secondary font-bold py-3 px-6 rounded-full text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 w-full sm:w-auto">
                        ✨ מסר למחר
                    </button>
                </div>
                
                <!-- Inspiration Feed -->
                <div id="inspiration-feed" class="mt-12 pt-6 border-t border-[var(--border-color)]">
                    <h2 id="inspiration-title" class="text-2xl font-bold text-center mb-4">בנק ההשראה מהעבר שלך</h2>
                    <div id="inspiration-content" class="space-y-3">
                        <!-- Content will be injected by JS -->
                    </div>
                    <div class="text-center mt-4">
                        <button id="refresh-inspiration" class="btn-secondary font-semibold py-2 px-4 rounded-full text-sm">
                            רענן השראה
                        </button>
                    </div>
                </div>

            </div>

            <!-- History View -->
            <div id="history-view" class="hidden">
                 <div class="flex items-center justify-between mb-4">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    <h2 id="calendar-month-year" class="text-2xl font-bold text-center"></h2>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center mb-6"></div>
                <div id="history-entry-display" class="bg-white p-6 rounded-lg shadow-inner hidden">
                    <h3 id="entry-date" class="text-xl font-bold mb-4"></h3>
                    <div id="entry-content" class="space-y-4 text-lg"></div>
                    <div id="history-actions" class="mt-4"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-notification fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl">
        <p id="toast-message"></p>
    </div>

    <!-- Tomorrow Message Modal -->
    <div id="tomorrow-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300 opacity-0">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-md w-full text-center transform scale-95 transition-all duration-300">
            <h3 class="text-2xl font-bold header-text mb-4">✨ מסר למחר ✨</h3>
            <p id="modal-message-text" class="text-lg text-gray-600 mb-6"></p>
            <button id="close-modal-btn" class="btn-primary font-bold py-2 px-6 rounded-full text-lg">הבנתי, תודה!</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        dayjs.extend(window.dayjs_plugin_isSameOrBefore); // Extend dayjs for streak calculation

        // --- CONFIG & STATE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDFYvzKavhrf4bnoFI0GckLk-dO40_ftJ4",
            authDomain: "eliran-apps.firebaseapp.com",
            projectId: "eliran-apps",
            storageBucket: "eliran-apps.firebasestorage.app",
            messagingSenderId: "383762752947",
            appId: "1:383762752947:web:24fd294ce0cea858f557c6",
            measurementId: "G-1NYMZVXBMP"
        };
        
        let app, auth, db, userId, entriesUnsubscribe;
        let isFirebaseReady = false;
        let userEntries = {};
        let selectedImageBase64 = null;
        let calendarDate = dayjs();
        let activeDate = dayjs().format('YYYY-MM-DD');

        // --- UPDATED ARRAYS ---
        const tomorrowMessages = [
            "תן/י לעצמך לנוח הלילה. מחר יום חדש מלא באפשרויות.",
            "כל צעד קטן שעשית היום בונה את ההצלחה הגדולה של מחר.",
            "הכוח לשנות את מחר נמצא בהחלטות הקטנות של היום.",
            "התמקד/י בטוב שהיה, והיפתח/י לטוב שעוד יגיע מחר.",
            "מחר הוא הזדמנות נוספת להיות הגרסה הטובה ביותר שלך.",
            "השלם/השלימי עם מה שהיה היום, והתרגש/י לקראת מה שיהיה מחר.",
            "אל תשכח/י - כל יום הוא מתנה. פתח/י את זו של מחר בסקרנות."
        ];
        const quotes = [
            { text: "ההווה הוא המתנה היקרה ביותר שיש לנו.", author: "ספנסר ג'ונסון" },
            { text: "שום דבר לא יכול לעמעם את האור שזורח מבפנים.", author: "מאיה אנג'לו" }, 
            { text: "מסע של אלף מייל מתחיל בצעד אחד.", author: "לאו דזה" },
            { text: "הדבר היחיד שעומד בינך לבין החלום שלך הוא הסיפור שאתה ממשיך לספר לעצמך למה אתה לא יכול להשיג אותו.", author: "ג'ורדן בלפורט" },
            { text: "החיים הם 10% מה שקורה לך ו-90% איך שאתה מגיב לזה.", author: "צ'ארלס ר. סווינדול" },
            { text: "אל תחכה. הזמן לעולם לא יהיה 'בדיוק מתאים'.", author: "נפוליאון היל" },
            { text: "הדרך הטובה ביותר לחזות את העתיד היא ליצור אותו.", author: "פיטר דרוקר" }
        ];

        // --- ELEMENTS ---
        const bodyEl = document.body;
        const journalView = document.getElementById('journal-view');
        const historyView = document.getElementById('history-view');
        const journalBtn = document.getElementById('journal-view-btn');
        const historyBtn = document.getElementById('history-view-btn');
        const saveButton = document.getElementById('save-button');
        const goodThingsEl = document.getElementById('good-things');
        const successesEl = document.getElementById('successes');
        const gratitudeEl = document.getElementById('gratitude');
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const historyEntryDisplay = document.getElementById('history-entry-display');
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const themeButtons = document.querySelectorAll('.theme-btn');
        const tomorrowMessageBtn = document.getElementById('tomorrow-message-btn');
        const tomorrowModal = document.getElementById('tomorrow-modal');
        const modalContent = document.getElementById('modal-content');
        const modalMessageText = document.getElementById('modal-message-text');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const journalDateDisplay = document.getElementById('journal-date-display');
        const backToTodayBtn = document.getElementById('back-to-today-btn');
        const inspirationContent = document.getElementById('inspiration-content');
        const refreshInspirationBtn = document.getElementById('refresh-inspiration');
        const streakDisplay = document.getElementById('streak-display');
        const streakCountEl = document.getElementById('streak-count');

        // --- INITIALIZATION ---
        function init() {
            dayjs.locale('he');
            setRandomQuote();
            setupEventListeners();
            initializeAppAndAuth();
        }
        
        function setRandomQuote() {
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('quote-text').textContent = `"${randomQuote.text}"`;
            document.getElementById('quote-author').textContent = `- ${randomQuote.author}`;
        }

        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        isFirebaseReady = true;
                        loadUserSettings();
                        listenToEntries(); // This will now also calculate and display the streak
                        loadEntryForDate(activeDate); 
                        updateJournalHeader();
                    } else {
                        signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showToast("שגיאה באתחול החיבור למסד הנתונים.");
            }
        }

        // --- SETTINGS & CUSTOMIZATION ---
        function applyTheme(themeName) {
            bodyEl.className = "text-gray-800";
            if (themeName !== 'default') {
                bodyEl.classList.add(`theme-${themeName}`);
            }
        }

        async function saveTheme(themeName) {
            if (!isFirebaseReady) return;
            try {
                const userDocRef = doc(db, 'goodDiaryUsers', userId);
                await setDoc(userDocRef, { settings: { theme: themeName } }, { merge: true });
            } catch (error) { console.error("Error saving theme:", error); }
        }

        async function loadUserSettings() {
            if (!isFirebaseReady) return;
            try {
                const userDocRef = doc(db, 'goodDiaryUsers', userId);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().settings && docSnap.data().settings.theme) {
                    applyTheme(docSnap.data().settings.theme);
                } else {
                    applyTheme('default');
                }
            } catch (error) { console.error("Error loading user settings:", error); }
        }
        
        // --- UI & NAVIGATION ---
        function showView(view) {
            if (view === 'journal') {
                journalView.classList.remove('hidden');
                historyView.classList.add('hidden');
                journalBtn.classList.replace('btn-secondary', 'btn-primary');
                historyBtn.classList.replace('btn-primary', 'btn-secondary');
            } else if (view === 'history') {
                historyView.classList.remove('hidden');
                journalView.classList.add('hidden');
                historyBtn.classList.replace('btn-secondary', 'btn-primary');
                journalBtn.classList.replace('btn-primary', 'btn-secondary');
                renderCalendar();
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            if (message.includes("שגיאה")) {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            }

            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 4000);
        }

        function showTomorrowMessage() {
            const randomMessage = tomorrowMessages[Math.floor(Math.random() * tomorrowMessages.length)];
            modalMessageText.textContent = randomMessage;
            tomorrowModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                tomorrowModal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95');
            });
        }

        function hideTomorrowMessage() {
            tomorrowModal.classList.remove('opacity-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => { tomorrowModal.classList.add('hidden'); }, 300); 
        }

        function clearJournalForm() {
            goodThingsEl.value = '';
            successesEl.value = '';
            gratitudeEl.value = '';
            selectedImageBase64 = null;
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            removeImageBtn.classList.add('hidden');
            imageUpload.value = '';
        }

        function updateJournalHeader() {
            const todayStr = dayjs().format('YYYY-MM-DD');
            journalDateDisplay.textContent = dayjs(activeDate).format('dddd, D MMMM YYYY');
            
            if (activeDate === todayStr) {
                saveButton.textContent = "שמור את היום הטוב שלי";
                backToTodayBtn.classList.add('hidden');
                tomorrowMessageBtn.classList.remove('hidden');
            } else {
                saveButton.textContent = `עדכן את יומן ה-${dayjs(activeDate).format('D/M')}`;
                backToTodayBtn.classList.remove('hidden');
                tomorrowMessageBtn.classList.add('hidden');
            }
        }

        // --- DATA HANDLING ---
        async function loadEntryForDate(dateStr) {
            clearJournalForm();
            if (!isFirebaseReady) return;
            try {
                const docRef = doc(db, 'goodDiaryUsers', userId, 'entries', dateStr);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    populateFormWithEntry(docSnap.data());
                }
            } catch (error) { console.error("Error loading entry:", error); }
        }
        
        function populateFormWithEntry(entry) {
             if (!entry) return;
             goodThingsEl.value = entry.goodThings || '';
             successesEl.value = entry.successes || '';
             gratitudeEl.value = entry.gratitude || '';
             if (entry.imageBase64) {
                 selectedImageBase64 = entry.imageBase64;
                 imagePreview.src = selectedImageBase64;
                 imagePreview.classList.remove('hidden');
                 removeImageBtn.classList.remove('hidden');
             } else {
                 selectedImageBase64 = null;
                 imagePreview.src = '';
                 imagePreview.classList.add('hidden');
                 removeImageBtn.classList.add('hidden');
             }
        }

        function listenToEntries() {
            if (entriesUnsubscribe) entriesUnsubscribe();
            if (!isFirebaseReady) return;
            const entriesCol = collection(db, 'goodDiaryUsers', userId, 'entries');
            entriesUnsubscribe = onSnapshot(entriesCol, (snapshot) => {
                userEntries = {};
                snapshot.forEach(doc => { userEntries[doc.id] = doc.data(); });
                
                // Update UI elements that depend on entries
                if (!historyView.classList.contains('hidden')) { renderCalendar(); }
                renderInspirationFeed(); 
                calculateAndDisplayStreak(); // Calculate and display streak

            }, (error) => { console.error("Error listening to entries:", error); });
        }

        async function saveEntry() {
            if (!isFirebaseReady) { showToast("שגיאה: החיבור למסד הנתונים עדיין לא מוכן."); return; }
            const entryData = {
                goodThings: goodThingsEl.value,
                successes: successesEl.value,
                gratitude: gratitudeEl.value,
                imageBase64: selectedImageBase64,
                date: activeDate,
            };
            
            saveButton.disabled = true;
            saveButton.textContent = "שומר...";
            try {
                const docRef = doc(db, 'goodDiaryUsers', userId, 'entries', activeDate);
                await setDoc(docRef, entryData, { merge: true });
                showToast("היומן עודכן בהצלחה");
            } catch (error) {
                console.error("Error saving entry:", error);
                if (error.code === 'invalid-argument' || (error.message && error.message.toLowerCase().includes('exceeds the maximum size'))) {
                    showToast("שגיאה: התמונה גדולה מדי (מעל 1MB). נסה/י תמונה קטנה יותר.");
                } else {
                    showToast("אירעה שגיאה בשמירת הנתונים.");
                }
            } finally {
                saveButton.disabled = false;
                updateJournalHeader();
            }
        }

        // --- CALENDAR LOGIC ---
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            calendarMonthYear.textContent = calendarDate.format('MMMM YYYY');
            const startOfMonth = calendarDate.startOf('month'), endOfMonth = calendarDate.endOf('month');
            const daysInMonth = endOfMonth.date(), startDayOfWeek = startOfMonth.day();
            const dayNames = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
            dayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = "font-bold subtle-text";
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });
            for (let i = 0; i < startDayOfWeek; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = "p-2 cursor-pointer rounded-full calendar-day";
                const dateStr = calendarDate.date(day).format('YYYY-MM-DD');
                if (userEntries[dateStr]) { dayEl.classList.add('has-entry'); }
                dayEl.addEventListener('click', () => showEntryForDate(dateStr));
                calendarGrid.appendChild(dayEl);
            }
        }

        function showEntryForDate(dateStr) {
            const entry = userEntries[dateStr];
            const displayDate = dayjs(dateStr).format('dddd, D MMMM YYYY');
            document.querySelectorAll('.calendar-day.selected-day').forEach(el => el.classList.remove('selected-day'));
            const dayNumber = dayjs(dateStr).date();
            const targetDayEl = Array.from(calendarGrid.children).find(el => el.textContent == dayNumber && !el.classList.contains('font-bold'));
            if(targetDayEl) targetDayEl.classList.add('selected-day');
            
            const historyActions = document.getElementById('history-actions');
            historyActions.innerHTML = '';

            if (entry) {
                document.getElementById('entry-date').textContent = `הסיכום שלי ליום ${displayDate}`;
                let imageHTML = '';
                if(entry.imageBase64) {
                    imageHTML = `<div class="flex justify-center mb-4"><img src="${entry.imageBase64}" class="max-h-64 rounded-lg shadow-md" /></div>`;
                }
                document.getElementById('entry-content').innerHTML = `
                    ${imageHTML}
                    <div class="border-b pb-2"><h4 class="font-semibold text-green-600">🌱 דברים טובים:</h4><p class="whitespace-pre-wrap">${entry.goodThings || 'לא צוין'}</p></div>
                    <div class="border-b pb-2"><h4 class="font-semibold text-blue-600">🏆 הצלחות:</h4><p class="whitespace-pre-wrap">${entry.successes || 'לא צוין'}</p></div>
                    <div><h4 class="font-semibold text-pink-500">💖 תודה על:</h4><p class="whitespace-pre-wrap">${entry.gratitude || 'לא צוין'}</p></div>`;
                
                const editButton = document.createElement('button');
                editButton.textContent = '✏️ ערוך יומן';
                editButton.className = 'btn-secondary font-bold py-2 px-4 rounded-full text-md';
                editButton.onclick = () => {
                    activeDate = dateStr;
                    populateFormWithEntry(entry);
                    updateJournalHeader();
                    showView('journal');
                };
                historyActions.appendChild(editButton);

                historyEntryDisplay.classList.remove('hidden');
            } else {
                 document.getElementById('entry-date').textContent = `אין יומן שמור ליום ${displayDate}`;
                 document.getElementById('entry-content').innerHTML = `<p class="text-center subtle-text">רוצה להוסיף יומן לתאריך זה?</p>`;
                 const addButton = document.createElement('button');
                 addButton.textContent = '✍️ הוסף יומן ליום זה';
                 addButton.className = 'btn-primary font-bold py-2 px-4 rounded-full text-md';
                 addButton.onclick = () => {
                     activeDate = dateStr;
                     clearJournalForm();
                     updateJournalHeader();
                     showView('journal');
                 };
                 historyActions.appendChild(addButton);
                 historyEntryDisplay.classList.remove('hidden');
            }
        }
        
        // --- INSPIRATION FEED ---
        function renderInspirationFeed() {
            inspirationContent.innerHTML = '';
            
            const allPositives = [];
            Object.values(userEntries).forEach(entry => {
                const date = entry.date;
                if (entry.goodThings) {
                    entry.goodThings.split('\n').filter(Boolean).forEach(text => {
                        allPositives.push({ type: 'good', text, date });
                    });
                }
                if (entry.successes) {
                    entry.successes.split('\n').filter(Boolean).forEach(text => {
                        allPositives.push({ type: 'success', text, date });
                    });
                }
                if (entry.gratitude) {
                    entry.gratitude.split('\n').filter(Boolean).forEach(text => {
                        allPositives.push({ type: 'gratitude', text, date });
                    });
                }
            });

            if (allPositives.length === 0) {
                inspirationContent.innerHTML = `<p class="text-center subtle-text">עדיין לא כתבת כלום. התחל/י לכתוב כדי למלא את בנק ההשראה!</p>`;
                return;
            }

            // Shuffle and pick 5
            const shuffled = allPositives.sort(() => 0.5 - Math.random());
            const itemsToShow = shuffled.slice(0, 5);

            itemsToShow.forEach(item => {
                let icon = '🌱';
                let styleClass = 'inspiration-card-good';
                if (item.type === 'success') {
                    icon = '🏆';
                    styleClass = 'inspiration-card-success';
                } else if (item.type === 'gratitude') {
                    icon = '💖';
                    styleClass = 'inspiration-card-gratitude';
                }

                const card = document.createElement('div');
                card.className = `inspiration-card p-4 rounded-lg shadow ${styleClass}`;
                card.innerHTML = `
                    <p class="text-lg font-semibold">${icon} ${item.text}</p>
                    <p class="text-sm inspiration-card-date subtle-text text-left">${dayjs(item.date).format('D MMMM YYYY')}</p>
                `;
                inspirationContent.appendChild(card);
            });
        }

        // --- STREAK CALCULATION ---
        function calculateAndDisplayStreak() {
             const entryDates = Object.keys(userEntries).sort().reverse(); // Get dates sorted newest first
             let streak = 0;
             let currentDate = dayjs();

             // Check if today has an entry OR if yesterday has an entry (streak counts if you wrote yesterday)
             const todayStr = currentDate.format('YYYY-MM-DD');
             const yesterdayStr = currentDate.subtract(1, 'day').format('YYYY-MM-DD');

             let lastEntryDate = null;

             if (userEntries[todayStr]) {
                 lastEntryDate = currentDate;
             } else if (userEntries[yesterdayStr]) {
                 lastEntryDate = currentDate.subtract(1, 'day');
             } else {
                 // No entry today or yesterday, streak is 0
                 streak = 0;
                 streakCountEl.textContent = streak;
                 return;
             }

             // Start counting from the last entry date found
             streak = 1;
             let checkDate = lastEntryDate.subtract(1, 'day');
             while (userEntries[checkDate.format('YYYY-MM-DD')]) {
                 streak++;
                 checkDate = checkDate.subtract(1, 'day');
             }

             streakCountEl.textContent = streak;
         }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            journalBtn.addEventListener('click', () => showView('journal'));
            historyBtn.addEventListener('click', () => showView('history'));
            saveButton.addEventListener('click', saveEntry);
            refreshInspirationBtn.addEventListener('click', renderInspirationFeed);

            document.getElementById('prev-month').addEventListener('click', () => { calendarDate = calendarDate.subtract(1, 'month'); renderCalendar(); });
            document.getElementById('next-month').addEventListener('click', () => { calendarDate = calendarDate.add(1, 'month'); renderCalendar(); });
            
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImageBase64 = e.target.result;
                    imagePreview.src = selectedImageBase64;
                    imagePreview.classList.remove('hidden');
                    removeImageBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            });

            removeImageBtn.addEventListener('click', () => {
                selectedImageBase64 = null;
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
                removeImageBtn.classList.add('hidden');
                imageUpload.value = '';
            });

            settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('hidden');
                setTimeout(() => {
                    settingsPanel.classList.toggle('opacity-0');
                    settingsPanel.classList.toggle('-translate-y-2');
                }, 10);
            });
            
            document.addEventListener('click', (e) => {
                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && e.target !== settingsBtn) {
                     settingsPanel.classList.add('opacity-0', '-translate-y-2');
                     setTimeout(()=> settingsPanel.classList.add('hidden'), 300);
                }
            });

            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const theme = button.dataset.theme;
                    applyTheme(theme);
                    saveTheme(theme);
                });
            });

            tomorrowMessageBtn.addEventListener('click', showTomorrowMessage);
            closeModalBtn.addEventListener('click', hideTomorrowMessage);
            tomorrowModal.addEventListener('click', (e) => { if (e.target === tomorrowModal) { hideTomorrowMessage(); } });
            
            backToTodayBtn.addEventListener('click', () => {
                activeDate = dayjs().format('YYYY-MM-DD');
                loadEntryForDate(activeDate);
                updateJournalHeader();
            });
        }
        
        // --- RUN APP ---
        init();
    </script>

</body>
</html>
