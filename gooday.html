<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×™×•××Ÿ ×”×˜×•×‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/he.js"></script>
    <style>
        :root {
            --bg-gradient-start: #E6F3FF;
            --bg-gradient-end: #F5F7FA;
            --primary-color: #3182CE;
            --primary-hover-color: #2B6CB0;
            --header-color: #3182CE;
        }

        body {
            font-family: 'Assistant', sans-serif;
            background-color: #F0F4F8; /* Light blue-gray background */
        }
        
        .theme-ocean {
            --bg-gradient-start: #E0F2F1;
            --bg-gradient-end: #F1F8E9;
            --primary-color: #00796B;
            --primary-hover-color: #004D40;
            --header-color: #00796B;
        }

        .theme-sunset {
            --bg-gradient-start: #FFF3E0;
            --bg-gradient-end: #FFECB3;
            --primary-color: #F57C00;
            --primary-hover-color: #E65100;
            --header-color: #F57C00;
        }

        .main-container {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        }
        .journal-textarea {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid #BEE3F8;
            transition: all 0.3s ease;
        }
        .journal-textarea:focus {
            background-color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 50%, transparent);
        }
        .header-text {
             color: var(--header-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover-color);
        }
        .btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #CBD5E0;
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:hover {
            transform: scale(1.05);
            background-color: #BEE3F8;
        }
        .has-entry {
            background-color: #68D391;
            color: white;
            border-radius: 50%;
            font-weight: bold;
        }
        .selected-day {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
        }
        .toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .settings-panel {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-xl mx-auto p-4 sm:p-6 min-h-screen">
        <!-- Header -->
        <header class="text-center mb-6 relative">
            <h1 class="text-4xl sm:text-5xl font-bold header-text">×™×•××Ÿ ×”×˜×•×‘ ×©×œ×™</h1>
            <p class="text-lg text-gray-500">×”××§×•× ×œ×˜×¤×— ×—×©×™×‘×” ×—×™×•×‘×™×ª, ×¢×¨×š ×¢×¦××™ ×•×”×•×“×™×”</p>
             <!-- Settings Button and Panel -->
            <div class="absolute top-0 left-0">
                <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 transition">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <div id="settings-panel" class="settings-panel hidden absolute left-0 mt-2 w-40 bg-white rounded-lg shadow-xl p-2 z-10 opacity-0 transform -translate-y-2">
                    <h4 class="text-sm font-bold text-gray-600 px-2 pb-1 text-right">×¢×¨×›×ª ×¦×‘×¢×™×</h4>
                    <button class="theme-btn w-full text-right p-2 hover:bg-gray-100 rounded" data-theme="default">ğŸ”µ ×‘×¨×™×¨×ª ××—×“×œ</button>
                    <button class="theme-btn w-full text-right p-2 hover:bg-gray-100 rounded" data-theme="ocean">ğŸŒŠ ××•×§×™×™× ×•×¡</button>
                    <button class="theme-btn w-full text-right p-2 hover:bg-gray-100 rounded" data-theme="sunset">ğŸŒ… ×©×§×™×¢×”</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center bg-white rounded-full shadow-md p-1 mb-6">
            <button id="journal-view-btn" class="px-6 py-2 rounded-full text-lg font-semibold flex-1 text-center btn-primary">×™×•××Ÿ ×™×•××™</button>
            <button id="history-view-btn" class="px-6 py-2 rounded-full text-lg font-semibold flex-1 text-center btn-secondary">×”×™×¡×˜×•×¨×™×”</button>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="main-container rounded-2xl shadow-lg p-6 sm:p-8">
            <!-- Journal View -->
            <div id="journal-view">
                <div class="text-center mb-6">
                    <p class="text-xl font-semibold text-gray-700" id="current-date"></p>
                </div>

                <!-- Inspiration Corner -->
                <div class="bg-yellow-100 border-r-4 border-yellow-400 text-yellow-800 p-4 rounded-lg mb-6 text-center italic">
                    <p id="quote-text">"×”×“×¨×š ×”×˜×•×‘×” ×‘×™×•×ª×¨ ×œ×—×–×•×ª ××ª ×”×¢×ª×™×“ ×”×™× ×œ×™×¦×•×¨ ××•×ª×•."</p>
                    <p id="quote-author" class="text-sm mt-1 not-italic font-semibold"></p>
                </div>

                <!-- Daily Photo Section -->
                <div class="mb-6">
                     <label class="block text-xl font-semibold text-gray-700 mb-2">ğŸ“¸ ×ª××•× ×ª ×”×™×•×</label>
                     <div class="mt-2 flex flex-col items-center">
                        <img id="image-preview" src="" class="hidden max-h-60 rounded-lg shadow mb-2"/>
                        <div id="image-controls" class="flex items-center gap-2">
                           <label for="image-upload" class="cursor-pointer bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50">×‘×—×¨/×™ ×ª××•× ×”</label>
                           <input id="image-upload" type="file" class="hidden" accept="image/*">
                           <button id="remove-image-btn" class="hidden p-2 text-red-500 hover:bg-red-100 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                           </button>
                        </div>
                     </div>
                </div>

                <!-- Journal Sections -->
                <div class="space-y-6">
                    <div>
                        <label for="good-things" class="block text-xl font-semibold text-gray-700 mb-2">ğŸŒ± ×”×“×‘×¨×™× ×”×˜×•×‘×™× ×©×§×¨×• ×œ×™ ×”×™×•×</label>
                        <textarea id="good-things" rows="5" class="journal-textarea w-full p-3 rounded-lg text-lg" placeholder="×œ×“×•×’××”: ×©×™×—×” ×˜×•×‘×” ×¢× ×—×‘×¨, ××¨×•×—×” ×˜×¢×™××”, ×©×™×¨ ×™×¤×” ×©×©××¢×ª×™..."></textarea>
                    </div>
                    <div>
                        <label for="successes" class="block text-xl font-semibold text-gray-700 mb-2">ğŸ† ×”×”×¦×œ×—×•×ª ×©×œ×™ ×œ×”×™×•×</label>
                        <textarea id="successes" rows="3" class="journal-textarea w-full p-3 rounded-lg text-lg" placeholder="×œ×“×•×’××”: ×¡×™×™××ª×™ ××©×™××” ×—×©×•×‘×” ×‘×¢×‘×•×“×”, ×¢××“×ª×™ ×‘×™×¢×“ ×‘××™××•×Ÿ..."></textarea>
                    </div>
                    <div>
                        <label for="gratitude" class="block text-xl font-semibold text-gray-700 mb-2">ğŸ’– ×ª×•×“×” ×¢×œ...</label>
                        <textarea id="gratitude" rows="3" class="journal-textarea w-full p-3 rounded-lg text-lg" placeholder="×œ×“×•×’××”: ×”××©×¤×—×” ×©×œ×™, ×”×‘×¨×™××•×ª, ×§×•×¨×ª ×”×’×’ ×©××¢×œ ×¨××©×™..."></textarea>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="save-button" class="btn-primary font-bold py-3 px-8 rounded-full text-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 w-full sm:w-auto">
                        ×©××•×¨ ××ª ×”×™×•× ×”×˜×•×‘ ×©×œ×™
                    </button>
                    <button id="tomorrow-message-btn" class="btn-secondary font-bold py-3 px-6 rounded-full text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 w-full sm:w-auto">
                        âœ¨ ××¡×¨ ×œ××—×¨
                    </button>
                </div>
            </div>

            <!-- History View -->
            <div id="history-view" class="hidden">
                 <div class="flex items-center justify-between mb-4">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                    <h2 id="calendar-month-year" class="text-2xl font-bold text-center"></h2>
                    <button id="next-month" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center mb-6"></div>
                <div id="history-entry-display" class="bg-white p-6 rounded-lg shadow-inner hidden">
                    <h3 id="entry-date" class="text-xl font-bold mb-4"></h3>
                    <div id="entry-content" class="space-y-4 text-lg"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-notification fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl">
        <p id="toast-message"></p>
    </div>

    <!-- Tomorrow Message Modal -->
    <div id="tomorrow-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300 opacity-0">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-md w-full text-center transform scale-95 transition-all duration-300">
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & STATE ---
        // 1. ×”×“×‘×§ ×›××Ÿ ××ª ×”×’×“×¨×•×ª ×”-Firebase ×©×œ×š!
        // ×ª×•×›×œ ×œ××¦×•× ××•×ª×Ÿ ×‘×”×’×“×¨×•×ª ×”×¤×¨×•×™×§×˜ ×‘-Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyDFYvzKavhrf4bnoFI0GckLk-dO40_ftJ4",
            authDomain: "eliran-apps.firebaseapp.com",
            projectId: "eliran-apps",
            storageBucket: "eliran-apps.firebasestorage.app",
            messagingSenderId: "383762752947",
            appId: "1:383762752947:web:24fd294ce0cea858f557c6",
            measurementId: "G-1NYMZVXBMP"
        };
        
        let app, auth, db, userId, entriesUnsubscribe;
        let userEntries = {};
        let selectedImageBase64 = null;
        let calendarDate = dayjs();

        const tomorrowMessages = [
            "××—×¨ ×”×•× ×“×£ ×—×œ×§. ×¦×™×™×¨/×™ ×¢×œ×™×• ×™×¦×™×¨×ª ××•×¤×ª.",
            "×–×›×•×¨/×–×›×¨×™ ××ª ×”×”×¦×œ×—×•×ª ×©×œ ×”×™×•×. ×”×Ÿ ×”×“×œ×§ ×©×œ×š ×œ××—×¨.",
            "×”××ª×’×¨×™× ×©×œ ××—×¨ ×”× ×”×”×–×“×× ×•×™×•×ª ×©×œ ××—×¨×ª×™×™×. ×’×©/×™ ××œ×™×”× ×‘×¡×§×¨× ×•×ª.",
            "××—×¨ ××‘×™× ××™×ª×• ×× ×¨×’×™×” ×—×“×©×”. ×§×‘×œ/×™ ××•×ª×” ×‘×–×¨×•×¢×•×ª ×¤×ª×•×—×•×ª.",
            "×ª×›× ×Ÿ/×™ ×œ×¢×¦××š ×¨×’×¢ ××—×“ ×©×œ ×©××—×” ×˜×”×•×¨×” ×œ××—×¨. ××’×™×¢ ×œ×š.",
            "×’× ×× ×”×™×•× ×”×™×” ×§×©×”, ××—×¨ ×”×©××© ×ª×–×¨×— ×©×•×‘. ×–×• ×”×‘×˜×—×”.",
            "×”×˜×•×‘ ×©×–×¨×¢×ª ×”×™×•×, ×™×¤×¨×— ××—×¨. ×”××©×š/×”××©×™×›×™ ×œ×–×¨×•×¢ ×˜×•×‘."
        ];

        const quotes = [
            { text: "×”××•×©×¨ ×ª×œ×•×™ ×‘× ×•.", author: "××¨×™×¡×˜×•" },
            { text: "×›×œ ×™×•× ×”×•× ×”×–×“×× ×•×ª ×—×“×©×”.", author: "×¡× ×§×”" },
            { text: "×”×›×¨×ª ×ª×•×“×” ×”×•×¤×›×ª ××ª ××” ×©×™×© ×œ× ×• ×œ××¡×¤×™×§.", author: "××œ×•×“×™ ×‘×™×˜×™" },
            { text: "×”×¦×œ×—×” ×”×™× ×¡×š ×”××××¦×™× ×”×§×˜× ×™×, ×©×—×•×–×¨×™× ×¢×œ ×¢×¦×× ×™×•× ×™×•×.", author: "×¨×•×‘×¨×˜ ×§×•×œ×™×™×¨" },
            { text: "×”×××™× ×• ×©××ª× ×™×›×•×œ×™×, ×•×›×‘×¨ ×¢×‘×¨×ª× ×—×¦×™ ××”×“×¨×š.", author: "×ª××•×“×•×¨ ×¨×•×–×•×•×œ×˜" },
            { text: "×”×¢×ª×™×“ ×©×™×™×š ×œ××œ×” ×”××××™× ×™× ×‘×™×•×¤×™×™× ×©×œ ×—×œ×•××•×ª×™×”×.", author: "××œ×™× ×•×¨ ×¨×•×–×•×•×œ×˜" }
        ];

        // --- ELEMENTS ---
        const bodyEl = document.body;
        const journalView = document.getElementById('journal-view');
        const historyView = document.getElementById('history-view');
        const journalBtn = document.getElementById('journal-view-btn');
        const historyBtn = document.getElementById('history-view-btn');
        const saveButton = document.getElementById('save-button');
        const goodThingsEl = document.getElementById('good-things');
        const successesEl = document.getElementById('successes');
        const gratitudeEl = document.getElementById('gratitude');
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const historyEntryDisplay = document.getElementById('history-entry-display');
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const themeButtons = document.querySelectorAll('.theme-btn');
        const tomorrowMessageBtn = document.getElementById('tomorrow-message-btn');
        const tomorrowModal = document.getElementById('tomorrow-modal');
        const modalContent = document.getElementById('modal-content');
        const modalMessageText = document.getElementById('modal-message-text');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // --- INITIALIZATION ---
        function init() {
            dayjs.locale('he');
            document.getElementById('current-date').textContent = dayjs().format('dddd, D MMMM YYYY');
            setRandomQuote();
            setupEventListeners();
            initializeAppAndAuth();
        }
        
        function setRandomQuote() {
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('quote-text').textContent = `"${randomQuote.text}"`;
            document.getElementById('quote-author').textContent = `- ${randomQuote.author}`;
        }

        async function initializeAppAndAuth() {
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "AIza...") {
                 console.error("Firebase config is not available or is a placeholder. Please add your own Firebase project configuration.");
                 alert("× ×¨××” ×©×—×¡×¨×” ×ª×¦×•×¨×ª Firebase. ×™×© ×œ×¢×“×›×Ÿ ××ª ×¤×¨×˜×™ ×”×¤×¨×•×™×§×˜ ×‘×§×•×“ ×›×“×™ ×œ×”×¤×¢×™×œ ××ª ×”××¤×œ×™×§×¦×™×”.");
                 return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        loadUserSettings();
                        loadTodayEntry();
                        listenToEntries();
                    } else {
                        signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        async function signIn() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        }

        // --- SETTINGS & CUSTOMIZATION ---
        function applyTheme(themeName) {
            bodyEl.classList.remove('theme-ocean', 'theme-sunset');
            if (themeName !== 'default') {
                bodyEl.classList.add(`theme-${themeName}`);
            }
        }

        async function saveTheme(themeName) {
            if (!userId) return;
            try {
                const userDocRef = doc(db, 'goodDiaryUsers', userId);
                await setDoc(userDocRef, { settings: { theme: themeName } }, { merge: true });
            } catch (error) {
                console.error("Error saving theme:", error);
            }
        }

        async function loadUserSettings() {
            if (!userId) return;
            try {
                const userDocRef = doc(db, 'goodDiaryUsers', userId);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().settings && docSnap.data().settings.theme) {
                    applyTheme(docSnap.data().settings.theme);
                }
            } catch (error) {
                console.error("Error loading user settings:", error);
            }
        }
        
        // --- UI & NAVIGATION ---
        function showView(view) {
            if (view === 'journal') {
                journalView.classList.remove('hidden');
                historyView.classList.add('hidden');
                journalBtn.classList.replace('btn-secondary', 'btn-primary');
                historyBtn.classList.replace('btn-primary', 'btn-secondary');
            } else if (view === 'history') {
                historyView.classList.remove('hidden');
                journalView.classList.add('hidden');
                historyBtn.classList.replace('btn-secondary', 'btn-primary');
                journalBtn.classList.replace('btn-primary', 'btn-secondary');
                renderCalendar();
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function showTomorrowMessage() {
            const randomMessage = tomorrowMessages[Math.floor(Math.random() * tomorrowMessages.length)];
            modalMessageText.textContent = randomMessage;
            
            tomorrowModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                tomorrowModal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95');
            });
        }

        function hideTomorrowMessage() {
            tomorrowModal.classList.remove('opacity-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                tomorrowModal.classList.add('hidden');
            }, 300); 
        }

        function clearJournalForm() {
            goodThingsEl.value = '';
            successesEl.value = '';
            gratitudeEl.value = '';
            selectedImageBase64 = null;
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            removeImageBtn.classList.add('hidden');
            imageUpload.value = '';
        }

        // --- DATA HANDLING ---
        async function loadTodayEntry() {
            if (!userId) return;
            const todayStr = dayjs().format('YYYY-MM-DD');
            try {
                const docRef = doc(db, 'goodDiaryUsers', userId, 'entries', todayStr);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    goodThingsEl.value = data.goodThings || '';
                    successesEl.value = data.successes || '';
                    gratitudeEl.value = data.gratitude || '';
                    if (data.imageBase64) {
                        selectedImageBase64 = data.imageBase64;
                        imagePreview.src = selectedImageBase64;
                        imagePreview.classList.remove('hidden');
                        removeImageBtn.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error("Error loading today's entry:", error);
            }
        }

        function listenToEntries() {
            if (entriesUnsubscribe) entriesUnsubscribe();
            if (!userId) return;
            const entriesCol = collection(db, 'goodDiaryUsers', userId, 'entries');
            entriesUnsubscribe = onSnapshot(entriesCol, (snapshot) => {
                userEntries = {};
                snapshot.forEach(doc => { userEntries[doc.id] = doc.data(); });
                if (!historyView.classList.contains('hidden')) { renderCalendar(); }
            }, (error) => { console.error("Error listening to entries:", error); });
        }

        async function saveEntry() {
            if (!userId) { showToast("×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×©××•×¨."); return; }
            const todayStr = dayjs().format('YYYY-MM-DD');
            const entryData = {
                goodThings: goodThingsEl.value,
                successes: successesEl.value,
                gratitude: gratitudeEl.value,
                imageBase64: selectedImageBase64,
                date: todayStr,
            };
            
            saveButton.disabled = true;
            saveButton.textContent = "×©×•××¨...";
            try {
                const docRef = doc(db, 'goodDiaryUsers', userId, 'entries', todayStr);
                await setDoc(docRef, entryData, { merge: true });
                showToast("×”×™×•× ×”×˜×•×‘ ×©×œ×š × ×©××¨");
                clearJournalForm();
            } catch (error) {
                console.error("Error saving entry:", error);
                showToast("××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×.");
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = "×©××•×¨ ××ª ×”×™×•× ×”×˜×•×‘ ×©×œ×™";
            }
        }

        // --- CALENDAR LOGIC ---
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            calendarMonthYear.textContent = calendarDate.format('MMMM YYYY');
            const startOfMonth = calendarDate.startOf('month'), endOfMonth = calendarDate.endOf('month');
            const daysInMonth = endOfMonth.date(), startDayOfWeek = startOfMonth.day();
            const dayNames = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
            dayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = "font-bold text-gray-500";
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });
            for (let i = 0; i < startDayOfWeek; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = "p-2 cursor-pointer rounded-full calendar-day";
                const dateStr = calendarDate.date(day).format('YYYY-MM-DD');
                if (userEntries[dateStr]) { dayEl.classList.add('has-entry'); }
                dayEl.addEventListener('click', () => showEntryForDate(dateStr));
                calendarGrid.appendChild(dayEl);
            }
        }

        function showEntryForDate(dateStr) {
            const entry = userEntries[dateStr];
            const displayDate = dayjs(dateStr).format('dddd, D MMMM YYYY');
            document.querySelectorAll('.calendar-day.selected-day').forEach(el => el.classList.remove('selected-day'));
            const dayNumber = dayjs(dateStr).date();
            const targetDayEl = Array.from(calendarGrid.children).find(el => el.textContent == dayNumber && !el.classList.contains('font-bold'));
            if(targetDayEl) targetDayEl.classList.add('selected-day');
            if (entry) {
                document.getElementById('entry-date').textContent = `×”×¡×™×›×•× ×©×œ×™ ×œ×™×•× ${displayDate}`;
                let imageHTML = '';
                if(entry.imageBase64) {
                    imageHTML = `<div class="flex justify-center mb-4"><img src="${entry.imageBase64}" class="max-h-64 rounded-lg shadow-md" /></div>`;
                }
                document.getElementById('entry-content').innerHTML = `
                    ${imageHTML}
                    <div class="border-b pb-2"><h4 class="font-semibold text-green-600">ğŸŒ± ×“×‘×¨×™× ×˜×•×‘×™×:</h4><p class="whitespace-pre-wrap">${entry.goodThings || '×œ× ×¦×•×™×Ÿ'}</p></div>
                    <div class="border-b pb-2"><h4 class="font-semibold text-blue-600">ğŸ† ×”×¦×œ×—×•×ª:</h4><p class="whitespace-pre-wrap">${entry.successes || '×œ× ×¦×•×™×Ÿ'}</p></div>
                    <div><h4 class="font-semibold text-pink-500">ğŸ’– ×ª×•×“×” ×¢×œ:</h4><p class="whitespace-pre-wrap">${entry.gratitude || '×œ× ×¦×•×™×Ÿ'}</p></div>`;
                historyEntryDisplay.classList.remove('hidden');
            } else {
                historyEntryDisplay.classList.add('hidden');
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            journalBtn.addEventListener('click', () => showView('journal'));
            historyBtn.addEventListener('click', () => showView('history'));
            saveButton.addEventListener('click', saveEntry);

            document.getElementById('prev-month').addEventListener('click', () => { calendarDate = calendarDate.subtract(1, 'month'); renderCalendar(); });
            document.getElementById('next-month').addEventListener('click', () => { calendarDate = calendarDate.add(1, 'month'); renderCalendar(); });
            
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImageBase64 = e.target.result;
                    imagePreview.src = selectedImageBase64;
                    imagePreview.classList.remove('hidden');
                    removeImageBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            });

            removeImageBtn.addEventListener('click', () => {
                selectedImageBase64 = null;
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
                removeImageBtn.classList.add('hidden');
                imageUpload.value = ''; // Reset file input
            });

            settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                settingsPanel.classList.toggle('hidden');
                setTimeout(() => {
                    settingsPanel.classList.toggle('opacity-0');
                    settingsPanel.classList.toggle('-translate-y-2');
                }, 10);
            });
            
            document.addEventListener('click', (e) => {
                if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && e.target !== settingsBtn) {
                     settingsPanel.classList.add('opacity-0', '-translate-y-2');
                     setTimeout(()=> settingsPanel.classList.add('hidden'), 300);
                }
            });

            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const theme = button.dataset.theme;
                    applyTheme(theme);
                    saveTheme(theme);
                });
            });

            tomorrowMessageBtn.addEventListener('click', showTomorrowMessage);
            closeModalBtn.addEventListener('click', hideTomorrowMessage);
            tomorrowModal.addEventListener('click', (e) => {
                if (e.target === tomorrowModal) { 
                    hideTomorrowMessage();
                }
            });
        }
        
        // --- RUN APP ---
        init();
    </script>

</body>
</html>
